(function($j){if(!$j||!($j.toJSON||Object.toJSON||_window.JSON)){throw new Error("jQuery, MooTools or Prototype needs to be loaded before jStorage!")}var _storage={},_storage_service={jStorage:"{}"},_storage_elm=null,_storage_size=0,json_encode=$j.toJSON||Object.toJSON||(_window.JSON&&(JSON.encode||JSON.stringify)),json_decode=$j.evalJSON||(_window.JSON&&(JSON.decode||JSON.parse))||function(str){return String(str).evalJSON()},_backend=false,_ttl_timeout,_XMLService={isXML:function(elm){var documentElement=(elm?elm.ownerDocument||elm:0).documentElement;return documentElement?documentElement.nodeName!=="HTML":false},encode:function(xmlNode){if(!this.isXML(xmlNode)){return false}try{return new XMLSerializer().serializeToString(xmlNode)}catch(E1){try{return xmlNode.xml}catch(E2){}}return false},decode:function(xmlString){var dom_parser=("DOMParser" in window&&(new DOMParser()).parseFromString)||(_window.ActiveXObject&&function(_xmlString){var xml_doc=new ActiveXObject("Microsoft.XMLDOM");xml_doc.async="false";xml_doc.loadXML(_xmlString);return xml_doc}),resultXML;if(!dom_parser){return false}resultXML=dom_parser.call("DOMParser" in _window&&(new DOMParser())||_window,xmlString,"text/xml");return this.isXML(resultXML)?resultXML:false}};function _init(){var localStorageReallyWorks=false;if("localStorage" in _window){try{_window.localStorage.setItem("_tmptest","tmpval");localStorageReallyWorks=true;_window.localStorage.removeItem("_tmptest")}catch(BogusQuotaExceededErrorOnIos5){}}if(localStorageReallyWorks){try{if(_window.localStorage){_storage_service=_window.localStorage;_backend="localStorage"}}catch(E3){}}else{if("globalStorage" in _window){try{if(_window.globalStorage){_storage_service=_window.globalStorage[_window.location.hostname];_backend="globalStorage"}}catch(E4){}}else{_storage_elm=document.createElement("link");if(_storage_elm.addBehavior){_storage_elm.style.behavior="url(#default#userData)";document.getElementsByTagName("head")[0].appendChild(_storage_elm);_storage_elm.load("jStorage");var data="{}";try{data=_storage_elm.getAttribute("jStorage")}catch(E5){}_storage_service.jStorage=data;_backend="userDataBehavior"}else{_storage_elm=null;return}}}_load_storage();_handleTTL()}function _load_storage(){if(_storage_service.jStorage){try{_storage=json_decode(String(_storage_service.jStorage))}catch(E6){_storage_service.jStorage="{}"}}else{_storage_service.jStorage="{}"}_storage_size=_storage_service.jStorage?String(_storage_service.jStorage).length:0}function _save(){try{_storage_service.jStorage=json_encode(_storage);if(_storage_elm){_storage_elm.setAttribute("jStorage",_storage_service.jStorage);_storage_elm.save("jStorage")}_storage_size=_storage_service.jStorage?String(_storage_service.jStorage).length:0}catch(E7){}}function _checkKey(key){if(!key||(typeof key!="string"&&typeof key!="number")){throw new TypeError("Key name must be string or numeric")}if(key=="__jstorage_meta"){throw new TypeError("Reserved key name")}return true}function _handleTTL(){var curtime,i,TTL,nextExpire=Infinity,changed=false;clearTimeout(_ttl_timeout);if(!_storage.__jstorage_meta||typeof _storage.__jstorage_meta.TTL!="object"){return}curtime=+new Date();TTL=_storage.__jstorage_meta.TTL;for(i in TTL){if(TTL.hasOwnProperty(i)){if(TTL[i]<=curtime){delete TTL[i];delete _storage[i];changed=true}else{if(TTL[i]<nextExpire){nextExpire=TTL[i]}}}}if(nextExpire!=Infinity){_ttl_timeout=setTimeout(_handleTTL,nextExpire-curtime)}if(changed){_save()}}$j.jStorage={version:"0.1.6.1",set:function(key,value){_checkKey(key);if(_XMLService.isXML(value)){value={_is_xml:true,xml:_XMLService.encode(value)}}else{if(typeof value=="function"){value=null}else{if(value&&typeof value=="object"){value=json_decode(json_encode(value))}}}_storage[key]=value;_save();return value},get:function(key,def){_checkKey(key);if(key in _storage){if(_storage[key]&&typeof _storage[key]=="object"&&_storage[key]._is_xml&&_storage[key]._is_xml){return _XMLService.decode(_storage[key].xml)}else{return _storage[key]}}return typeof(def)=="undefined"?null:def},deleteKey:function(key){_checkKey(key);if(key in _storage){delete _storage[key];if(_storage.__jstorage_meta&&typeof _storage.__jstorage_meta.TTL=="object"&&key in _storage.__jstorage_meta.TTL){delete _storage.__jstorage_meta.TTL[key]}_save();return true}return false},setTTL:function(key,ttl){var curtime=+new Date();_checkKey(key);ttl=Number(ttl)||0;if(key in _storage){if(!_storage.__jstorage_meta){_storage.__jstorage_meta={}}if(!_storage.__jstorage_meta.TTL){_storage.__jstorage_meta.TTL={}}if(ttl>0){_storage.__jstorage_meta.TTL[key]=curtime+ttl}else{delete _storage.__jstorage_meta.TTL[key]}_save();_handleTTL();return true}return false},flush:function(){_storage={};_save();return true},storageObj:function(){function F(){}F.prototype=_storage;return new F()},index:function(){var index=[],i;for(i in _storage){if(_storage.hasOwnProperty(i)&&i!="__jstorage_meta"){index.push(i)}}return index},storageSize:function(){return _storage_size},currentBackend:function(){return _backend},storageAvailable:function(){return !!_backend},reInit:function(){var new_storage_elm,data;if(_storage_elm&&_storage_elm.addBehavior){new_storage_elm=document.createElement("link");_storage_elm.parentNode.replaceChild(new_storage_elm,_storage_elm);_storage_elm=new_storage_elm;_storage_elm.style.behavior="url(#default#userData)";document.getElementsByTagName("head")[0].appendChild(_storage_elm);_storage_elm.load("jStorage");data="{}";try{data=_storage_elm.getAttribute("jStorage")}catch(E5){}_storage_service.jStorage=data;_backend="userDataBehavior"}_load_storage()}};_init()})($j);